from convert_utils import l2_normalize_XYZ,gamma_encode, gamma_decode
from icc_rw import *
from lut import *
import re
import matplotlib.pyplot as plt

gray = """[18:04:05] (1/128) 灰阶 0：XYZ [0.0176   0.017518 0.010708] xy [0.38406145 0.38227207]
[18:04:10] (2/128) 灰阶 8：XYZ [0.012573 0.014137 0.011366] xy [0.33020801 0.37128375]
[18:04:15] (3/128) 灰阶 16：XYZ [0.051974 0.05143  0.047589] xy [0.34421463 0.34061182]
[18:04:20] (4/128) 灰阶 24：XYZ [0.081047 0.078137 0.081365] xy [0.33692512 0.32482779]
[18:04:25] (5/128) 灰阶 32：XYZ [0.140312 0.132447 0.165447] xy [0.32019644 0.30224826]
[18:04:30] (6/128) 灰阶 40：XYZ [0.197616 0.193133 0.235217] xy [0.31569766 0.30853593]
[18:04:35] (7/128) 灰阶 48：XYZ [0.26     0.253435 0.313222] xy [0.31451981 0.30657818]
[18:04:40] (8/128) 灰阶 56：XYZ [0.342251 0.34287  0.406252] xy [0.31359673 0.3141639 ]
[18:04:45] (9/128) 灰阶 64：XYZ [0.429868 0.430896 0.505947] xy [0.31452736 0.31527953]
[18:04:51] (10/128) 灰阶 72：XYZ [0.537697 0.5462   0.640364] xy [0.311842   0.31677339]
[18:04:56] (11/128) 灰阶 81：XYZ [0.654131 0.664417 0.790172] xy [0.31020287 0.31508071]
[18:05:01] (12/128) 灰阶 89：XYZ [0.794328 0.823297 0.940212] xy [0.31054676 0.32187235]
[18:05:06] (13/128) 灰阶 97：XYZ [0.937802 0.965958 1.117643] xy [0.31038627 0.31970512]
[18:05:11] (14/128) 灰阶 105：XYZ [1.119979 1.157665 1.324126] xy [0.31095239 0.32141558]
[18:05:16] (15/128) 灰阶 113：XYZ [1.287327 1.324084 1.538245] xy [0.31022499 0.31908283]
[18:05:21] (16/128) 灰阶 121：XYZ [1.473468 1.526559 1.755297] xy [0.30985649 0.32102103]
[18:05:26] (17/128) 灰阶 129：XYZ [1.682402 1.726782 2.009074] xy [0.31050607 0.31869689]
[18:05:31] (18/128) 灰阶 137：XYZ [1.920171 1.990703 2.280681] xy [0.31012742 0.32151907]
[18:05:36] (19/128) 灰阶 145：XYZ [2.139769 2.204036 2.534267] xy [0.31110012 0.32044387]
[18:05:41] (20/128) 灰阶 153：XYZ [2.406248 2.484027 2.825993] xy [0.31184091 0.32192078]
[18:05:46] (21/128) 灰阶 161：XYZ [2.655275 2.739892 3.139707] xy [0.31110887 0.32102313]
[18:05:51] (22/128) 灰阶 169：XYZ [2.966379 3.067877 3.487009] xy [0.31155303 0.32221317]
[18:05:56] (23/128) 灰阶 177：XYZ [3.23594  3.360011 3.796388] xy [0.31137745 0.32331615]
[18:06:01] (24/128) 灰阶 185：XYZ [3.573652 3.70071  4.182829] xy [0.31191345 0.32300326]
[18:06:06] (25/128) 灰阶 193：XYZ [3.876086 4.012398 4.532669] xy [0.31205525 0.32302943]
[18:06:12] (26/128) 灰阶 201：XYZ [4.272658 4.418661 5.007256] xy [0.31190529 0.32256355]
[18:06:17] (27/128) 灰阶 209：XYZ [4.628535 4.793667 5.39168 ] xy [0.31244579 0.3235929 ]
[18:06:22] (28/128) 灰阶 217：XYZ [5.040384 5.213989 5.890936] xy [0.31218876 0.32294142]
[18:06:27] (29/128) 灰阶 226：XYZ [5.440269 5.617661 6.366535] xy [0.31222015 0.32240077]
[18:06:32] (30/128) 灰阶 234：XYZ [5.910542 6.096981 6.907038] xy [0.31248634 0.32234325]
[18:06:37] (31/128) 灰阶 242：XYZ [6.336792 6.532518 7.40987 ] xy [0.31247772 0.3221293 ]
[18:06:42] (32/128) 灰阶 250：XYZ [6.891323 7.095245 8.057417] xy [0.31261693 0.32186762]
[18:06:47] (33/128) 灰阶 258：XYZ [7.366095 7.591008 8.638281] xy [0.31218373 0.32171581]
[18:06:52] (34/128) 灰阶 266：XYZ [7.887066 8.121269 9.268898] xy [0.31202252 0.3212879 ]
[18:06:57] (35/128) 灰阶 274：XYZ [8.387983 8.62833  9.806198] xy [0.31272177 0.32168241]
[18:07:02] (36/128) 灰阶 282：XYZ [ 8.963412  9.222039 10.531679] xy [0.31212771 0.32113373]
[18:07:07] (37/128) 灰阶 290：XYZ [ 9.56804   9.84794  11.275274] xy [0.31175135 0.32087122]
[18:07:12] (38/128) 灰阶 298：XYZ [10.250737 10.522721 12.026046] xy [0.3125272  0.32081952]
[18:07:17] (39/128) 灰阶 306：XYZ [10.782738 11.069635 12.585547] xy [0.31310654 0.32143739]
[18:07:22] (40/128) 灰阶 314：XYZ [11.490749 11.803621 13.421448] xy [0.31296454 0.32148599]
[18:07:26] (41/128) 灰阶 322：XYZ [11.862865 12.20757  13.888939] xy [0.31251477 0.32159566]
[18:07:31] (42/128) 灰阶 330：XYZ [12.579445 12.917186 14.801552] xy [0.31215911 0.32054016]
[18:07:35] (43/128) 灰阶 338：XYZ [13.261261 13.614567 15.626463] xy [0.31201285 0.32032549]
[18:07:39] (44/128) 灰阶 346：XYZ [13.970207 14.33166  16.486581] xy [0.31191541 0.31998564]
[18:07:43] (45/128) 灰阶 354：XYZ [14.500586 14.898415 17.159954] xy [0.31144569 0.31999032]
[18:07:46] (46/128) 灰阶 362：XYZ [15.221997 15.618557 17.975754] xy [0.31182196 0.31994548]
[18:07:50] (47/128) 灰阶 371：XYZ [15.817568 16.257759 18.671336] xy [0.31169671 0.320371  ]
[18:07:53] (48/128) 灰阶 379：XYZ [16.566999 17.011313 19.572016] xy [0.31170079 0.32006036]
[18:07:57] (49/128) 灰阶 387：XYZ [17.143945 17.596345 20.236652] xy [0.31183883 0.32006773]
[18:08:00] (50/128) 灰阶 395：XYZ [17.942056 18.388363 21.112453] xy [0.31234608 0.32011566]
[18:08:03] (51/128) 灰阶 403：XYZ [18.562217 19.017707 21.734093] xy [0.31294824 0.32062753]
[18:08:06] (52/128) 灰阶 411：XYZ [19.347109 19.796619 22.679469] xy [0.31294255 0.32021345]
[18:08:09] (53/128) 灰阶 419：XYZ [20.017247 20.505055 23.492598] xy [0.31269668 0.32031691]
[18:08:12] (54/128) 灰阶 427：XYZ [20.829593 21.337925 24.425227] xy [0.31279073 0.32042417]
[18:08:15] (55/128) 灰阶 435：XYZ [21.483511 22.013343 25.197243] xy [0.31274173 0.32045465]
[18:08:17] (56/128) 灰阶 443：XYZ [22.267693 22.802926 26.143561] xy [0.31268622 0.32020204]
[18:08:20] (57/128) 灰阶 451：XYZ [22.956566 23.534848 26.970439] xy [0.31249642 0.32036829]
[18:08:23] (58/128) 灰阶 459：XYZ [23.712308 24.364536 27.989287] xy [0.3117328  0.32030729]
[18:08:25] (59/128) 灰阶 467：XYZ [24.44492  25.044133 28.868462] xy [0.3119665  0.31961367]
[18:08:28] (60/128) 灰阶 475：XYZ [25.558597 26.155959 30.205855] xy [0.31199303 0.31928501]
[18:08:31] (61/128) 灰阶 483：XYZ [26.409098 27.028292 31.125807] xy [0.31230014 0.3196224 ]
[18:08:33] (62/128) 灰阶 491：XYZ [27.429972 28.073828 32.259332] xy [0.3125455  0.31988179]
[18:08:36] (63/128) 灰阶 499：XYZ [28.300038 28.978393 33.288408] xy [0.31247682 0.31996693]
[18:08:38] (64/128) 灰阶 507：XYZ [29.416212 30.150287 34.701802] xy [0.31204776 0.31983484]
[18:08:41] (65/128) 灰阶 516：XYZ [30.976924 31.686812 36.614559] xy [0.31202111 0.3191716 ]
[18:08:44] (66/128) 灰阶 524：XYZ [32.121359 32.917568 37.959157] xy [0.31186366 0.31959398]
[18:08:46] (67/128) 灰阶 532：XYZ [33.03229  33.872303 38.932364] xy [0.31210544 0.3200423 ]
[18:08:49] (68/128) 灰阶 540：XYZ [34.097155 35.010843 40.178195] xy [0.31199874 0.32035925]
[18:08:51] (69/128) 灰阶 548：XYZ [35.233109 36.213055 41.678638] xy [0.31145344 0.32011596]
[18:08:54] (70/128) 灰阶 556：XYZ [36.475241 37.541851 43.103188] xy [0.31143403 0.32054099]
[18:08:57] (71/128) 灰阶 564：XYZ [37.533152 38.532645 44.487302] xy [0.31134125 0.31963214]
[18:08:59] (72/128) 灰阶 572：XYZ [38.879395 39.907929 46.093605] xy [0.31133172 0.31956784]
[18:09:02] (73/128) 灰阶 580：XYZ [39.925262 40.942408 47.243814] xy [0.31164468 0.31958421]
[18:09:04] (74/128) 灰阶 588：XYZ [41.337766 42.390471 48.840566] xy [0.31182122 0.31976204]
[18:09:07] (75/128) 灰阶 596：XYZ [42.537875 43.513885 50.22956 ] xy [0.31213284 0.31929457]
[18:09:10] (76/128) 灰阶 604：XYZ [44.008533 45.059998 51.917987] xy [0.3121471  0.31960501]
[18:09:12] (77/128) 灰阶 612：XYZ [45.221657 46.31466  53.100442] xy [0.31265674 0.32021362]
[18:09:15] (78/128) 灰阶 620：XYZ [46.515874 47.665826 54.610544] xy [0.31262298 0.32035155]
[18:09:17] (79/128) 灰阶 628：XYZ [47.69045  48.886994 56.087876] xy [0.31238562 0.32022331]
[18:09:20] (80/128) 灰阶 636：XYZ [49.229045 50.495064 57.776571] xy [0.31256402 0.3206022 ]
[18:09:23] (81/128) 灰阶 644：XYZ [49.595961 50.878768 58.282881] xy [0.31240053 0.32048081]
[18:09:25] (82/128) 灰阶 652：XYZ [51.045621 52.326929 59.963105] xy [0.31251977 0.3203644 ]
[18:09:28] (83/128) 灰阶 661：XYZ [53.110981 54.446034 62.39166 ] xy [0.31251189 0.32036751]
[18:09:30] (84/128) 灰阶 669：XYZ [54.626241 55.992886 64.063419] xy [0.31271722 0.32054082]
[18:09:33] (85/128) 灰阶 677：XYZ [55.935376 57.319204 65.709012] xy [0.31255171 0.32028416]
[18:09:36] (86/128) 灰阶 685：XYZ [57.408403 58.853162 67.336095] xy [0.31268592 0.32055508]
[18:09:38] (87/128) 灰阶 693：XYZ [58.852622 60.313685 69.080697] xy [0.31263511 0.32039652]
[18:09:41] (88/128) 灰阶 701：XYZ [60.482497 62.089174 70.964677] xy [0.31251234 0.32081402]
[18:09:43] (89/128) 灰阶 709：XYZ [62.180063 63.855503 72.982648] xy [0.31243403 0.32085256]
[18:09:46] (90/128) 灰阶 717：XYZ [63.746535 65.510287 74.760593] xy [0.31245634 0.32110145]
[18:09:49] (91/128) 灰阶 725：XYZ [65.254561 67.083604 76.669507] xy [0.31221132 0.3209624 ]
[18:09:51] (92/128) 灰阶 733：XYZ [67.065209 69.032222 78.743818] xy [0.3121617  0.32131736]
[18:09:54] (93/128) 灰阶 741：XYZ [68.612888 70.55643  80.605298] xy [0.3121966  0.32103994]
[18:09:57] (94/128) 灰阶 749：XYZ [70.161861 72.179964 82.476505] xy [0.31208248 0.32105907]
[18:09:59] (95/128) 灰阶 757：XYZ [71.606074 73.6763   84.281112] xy [0.31192275 0.32094085]
[18:10:02] (96/128) 灰阶 765：XYZ [73.463941 75.544237 86.412326] xy [0.31205413 0.32089064]
[18:10:04] (97/128) 灰阶 773：XYZ [75.062771 77.120655 88.326263] xy [0.31209874 0.32065509]
[18:10:07] (98/128) 灰阶 781：XYZ [76.906742 79.034762 90.472129] xy [0.31210425 0.32074022]
[18:10:10] (99/128) 灰阶 789：XYZ [78.70158  80.800152 92.586838] xy [0.31219813 0.32052287]
[18:10:12] (100/128) 灰阶 797：XYZ [80.540036 82.727334 94.703026] xy [0.31220651 0.32068538]
[18:10:15] (101/128) 灰阶 806：XYZ [82.173783 84.389187 96.71426 ] xy [0.31211884 0.32053356]
[18:10:17] (102/128) 灰阶 814：XYZ [84.012372 86.313516 98.866645] xy [0.31209028 0.3206386 ]
[18:10:20] (103/128) 灰阶 822：XYZ [ 85.730251  88.055273 100.940878] xy [0.31205683 0.32051988]
[18:10:23] (104/128) 灰阶 830：XYZ [ 87.653701  90.027483 103.175373] xy [0.31209419 0.32054613]
[18:10:25] (105/128) 灰阶 838：XYZ [ 89.378536  91.79784  105.248251] xy [0.31204906 0.32049563]
[18:10:28] (106/128) 灰阶 846：XYZ [ 91.314198  93.797414 107.458676] xy [0.31211029 0.32059788]
[18:10:30] (107/128) 灰阶 854：XYZ [ 93.170487  95.655006 109.565196] xy [0.31224328 0.32056967]
[18:10:33] (108/128) 灰阶 862：XYZ [ 95.201538  97.575771 111.898201] xy [0.31246863 0.32026129]
[18:10:36] (109/128) 灰阶 870：XYZ [ 96.907122  99.415344 113.925591] xy [0.31235368 0.32043825]
[18:10:38] (110/128) 灰阶 878：XYZ [ 99.015888 101.574761 116.502087] xy [0.31226161 0.3203314 ]
[18:10:41] (111/128) 灰阶 886：XYZ [100.827297 103.502548 118.57455 ] xy [0.31225124 0.3205362 ]
[18:10:43] (112/128) 灰阶 894：XYZ [102.998904 105.63912  121.129973] xy [0.31233748 0.32034376]
[18:10:46] (113/128) 灰阶 902：XYZ [104.834454 107.562751 123.260833] xy [0.31232517 0.32045337]
[18:10:49] (114/128) 灰阶 910：XYZ [106.982399 109.696784 125.892695] xy [0.31229183 0.32021538]
[18:10:51] (115/128) 灰阶 918：XYZ [108.7508   111.562857 127.957869] xy [0.31225866 0.32033298]
[18:10:54] (116/128) 灰阶 926：XYZ [111.006866 113.817134 130.612517] xy [0.31231137 0.3202179 ]
[18:10:56] (117/128) 灰阶 934：XYZ [112.917879 115.878076 132.772891] xy [0.3122998  0.32048689]
[18:10:59] (118/128) 灰阶 942：XYZ [115.168609 118.190268 135.257205] xy [0.31243512 0.32063242]
[18:11:02] (119/128) 灰阶 951：XYZ [117.128915 120.299646 137.333353] xy [0.31254221 0.32100286]
[18:11:04] (120/128) 灰阶 959：XYZ [119.470489 122.673859 140.01543 ] xy [0.31261921 0.32100149]
[18:11:07] (121/128) 灰阶 967：XYZ [121.476795 124.858066 142.307788] xy [0.31256682 0.32126702]
[18:11:10] (122/128) 灰阶 975：XYZ [123.832682 127.22205  145.035827] xy [0.3126373  0.32119435]
[18:11:12] (123/128) 灰阶 983：XYZ [125.829674 129.296864 147.429217] xy [0.31257701 0.32118995]
[18:11:15] (124/128) 灰阶 991：XYZ [128.299812 131.733888 150.45224 ] xy [0.31255592 0.3209218 ]
[18:11:17] (125/128) 灰阶 999：XYZ [130.184861 133.638966 152.702642] xy [0.31254883 0.32084147]
[18:11:20] (126/128) 灰阶 1007：XYZ [132.564328 135.945298 155.667797] xy [0.31252094 0.32049159]
[18:11:23] (127/128) 灰阶 1015：XYZ [134.548228 137.939087 157.93704 ] xy [0.31259437 0.32047231]
[18:11:25] (128/128) 灰阶 1023：XYZ [137.20472  140.688867 161.118755] xy [0.31253044 0.32046677]
"""

y_values = []
for line in gray.strip().split('\n'):
    match = re.search(r'XYZ\s*\[([\d\.\s]+)\]', line)
    if match:
        xyz_str = match.group(1)
        # Split by whitespace and filter out empty strings
        xyz = [float(x) for x in xyz_str.split()]
        if len(xyz) >= 2:
            y_values.append(xyz[1])
y_values[0] = 0.0
print(y_values)
rgbw = """[18:12:51] R：XYZ 77.5911,35.1179,1.1308 xy 0.6816,0.3085
[18:12:54] G：XYZ 32.3716,96.6509,5.4975 xy 0.2406,0.7185
[18:12:56] B：XYZ 29.3715,10.6349,155.7323 xy 0.1501,0.0543
[18:12:59] W：XYZ 137.4940,140.9680,161.6631 xy 0.3124,0.3203"""

rgbw_dict = {}
for line in rgbw.strip().split('\n'):
    match = re.search(r'([RGBW])：XYZ\s*([\d\.,]+)', line)
    if match:
        color = match.group(1)
        xyz_str = match.group(2)
        xyz = [float(x) for x in xyz_str.split(',')]
        rgbw_dict[color] = l2_normalize_XYZ(xyz)

# for idx,itm in enumerate(y_values):
#     print(idx, gamma_decode(itm/max(y_values), 2.2), idx/255.0)
y_value_decode = [gamma_decode(itm/max(y_values), 2.2) for itm in y_values]
m,_ = max_uniform_target(len(y_value_decode), 40960)
y_value_decode_extend = linear_interpolate(np.array(y_value_decode), m)
target_lut = [i/1023 for i in range(1024)]
t= []
for idx, itm in enumerate(target_lut):
    i = find_nearest_idx(y_value_decode_extend, itm)
    t.append(i/(m-1))
t[0] = 0.0
t[-1] = 1.0
for itm in t[-100:]:
    print(itm)
from meta_data import D65_WHITE_POINT
xyz = xyY_to_XYZ([*D65_WHITE_POINT, 10000])
wtpt = l2_normalize_XYZ(xyz)
icc_handle = ICCProfile("data\\hdr_empty.icc")
data = icc_handle.read_all()
icc_handle.write_XYZType("rXYZ", [rgbw_dict['R']])
icc_handle.write_XYZType("gXYZ", [rgbw_dict['G']])
icc_handle.write_XYZType("bXYZ", [rgbw_dict['B']])
icc_handle.write_XYZType("wtpt", [wtpt])
max_lumi = 141.0
icc_handle.write_XYZType("lumi", [[max_lumi, max_lumi, max_lumi]])

MHC2 = icc_handle.read_MHC2()
MHC2["red_lut"] = t
MHC2["green_lut"] = t
MHC2["blue_lut"] = t
MHC2["entry_count"] = len(MHC2["red_lut"])
MHC2["min_luminance"] = 0
MHC2["peak_luminance"] = max_lumi

icc_handle.write_MHC2(MHC2)

import os
filename = "oled_acm_lut_128.icc"
name_without_ext = os.path.splitext(filename)[0]
desc = [{"lang": "en", "country": "US", "text": name_without_ext}]
icc_handle.write_desc(desc)
icc_handle.rebuild()
icc_handle.save(filename)

# print(rgbw_dict)
gamma_values = [gamma_encode(c / (len(y_values)-1), 2.2) for c in range(len(y_values))]
plt.figure()
plt.plot([y / max(y_values) for y in y_values], label='Measured Y (Normalized)')
plt.plot(gamma_values, label='Gamma 2.2')
plt.title("Y Values from Gray Scale vs Gamma 2.2")
plt.xlabel("Index")
plt.ylabel("Y Value")
plt.legend()
plt.grid(True)
plt.show()




